<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èƒŒèª¦å°åŠ©æ‰‹</title>

<style>
  body{font-family:system-ui,-apple-system; margin:0; background:#f6f7f9;}
  .wrap{max-width:920px; margin:0 auto; padding:16px;}
  .card{background:#fff; border-radius:14px; padding:16px; margin:14px 0; box-shadow:0 2px 12px rgba(0,0,0,.06);}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  button, select{
    padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; font-size:14px;
  }
  button.primary{background:#111; color:#fff; border-color:#111;}
  button:disabled{opacity:.45; cursor:not-allowed;}
  textarea{
    width:100%; height:120px; border-radius:12px; border:1px solid #ddd; padding:12px; box-sizing:border-box;
  }
  .target{font-size:16px; line-height:1.7; white-space:pre-wrap;}
  .muted{color:#666; font-size:12px; line-height:1.5;}
  .ok{background:#eaffea;padding:2px 4px;border-radius:6px;}
  .miss{background:#ffecec;padding:2px 4px;border-radius:6px;}
  .wrong{background:#e8f0ff;padding:2px 4px;border-radius:6px;}
  .titleRow{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
</style>
</head>

<body>
<div class="wrap">
  <h2 class="titleRow">ğŸ“š èƒŒèª¦å°åŠ©æ‰‹ <span class="muted">ï¼ˆå»ºè­°ç”¨ https + æ‰‹æ©Ÿ Chromeï¼‰</span></h2>

  <!-- åŠŸèƒ½é¸å–® -->
  <div class="card">
    <b>åŠŸèƒ½é¸å–®</b>
    <div class="row" style="margin-top:10px;">
      <button id="tabView" class="primary">ğŸ“– æ–‡ç« å±•ç¤º</button>
      <button id="tabRec">ğŸ™ï¸ èƒŒèª¦ç·´ç¿’</button>
    </div>
  </div>

  <!-- ================= æ–‡ç« å±•ç¤ºé  ================= -->
  <div id="pageView">
    <div class="card">
      <b>é¸æ“‡æ—¥æœŸæ–‡ç« </b>
      <div class="row" style="margin-top:10px;">
        <select id="articleSelector"></select>
        <button id="loadArticle" class="primary">è¼‰å…¥</button>

        <button id="ttsFullNormal">ğŸ”Š å…¨æ–‡ï¼ˆæ­£å¸¸ï¼‰</button>
        <button id="ttsFullSlow">ğŸ¢ å…¨æ–‡ï¼ˆæ…¢é€Ÿï¼‰</button>
        <button id="ttsPause" disabled>â¸ï¸ æš«åœ</button>
        <button id="ttsResume" disabled>â–¶ï¸ ç¹¼çºŒ</button>
        <button id="ttsStop" disabled>â¹ï¸ åœæ­¢</button>

        <span class="muted" id="supportText"></span>
      </div>

      <div style="margin-top:10px;font-weight:700;" id="articleTitle"></div>
      <div class="muted" id="articleMeta"></div>

      <div style="margin-top:10px;">
        <div class="muted">æ–‡ç« å…§å®¹ï¼š</div>
        <div id="articleBody" class="target"></div>
      </div>
    </div>
  </div>

  <!-- ================= èƒŒèª¦ç·´ç¿’é  ================= -->
  <div id="pageRec" style="display:none;">

    <!-- èƒŒèª¦é æ—¥æœŸé¸å–® -->
    <div class="card">
      <b>é¸æ“‡æ—¥æœŸæ–‡ç« ï¼ˆèƒŒèª¦ç”¨ï¼‰</b>
      <div class="row" style="margin-top:10px;">
        <select id="articleSelectorRec"></select>
        <button id="loadArticleRec" class="primary">è¼‰å…¥</button>
        <span class="muted" id="recMeta"></span>
      </div>
      <div class="muted" id="recTitleLine" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <b>èƒŒèª¦æ¨¡å¼</b>
      <div class="row" style="margin-top:10px;">
        <select id="mode">
          <option value="single">å–®å¥èƒŒèª¦</option>
          <option value="triple">ä¸‰å¥èƒŒèª¦</option>
          <option value="full">æ•´ç¯‡èƒŒèª¦</option>
        </select>
        <button id="prev">ä¸Šä¸€æ®µ</button>
        <button id="next">ä¸‹ä¸€æ®µ</button>
        <button id="ttsTargetNormal">ğŸ”Š æœ¬æ®µï¼ˆæ­£å¸¸ï¼‰</button>
        <button id="ttsTargetSlow">ğŸ¢ æœ¬æ®µï¼ˆæ…¢é€Ÿï¼‰</button>
      </div>

      <!-- âœ… ç›®æ¨™ç‰‡æ®µå€å¡Šï¼šé–‹å§‹è­˜åˆ¥å¾Œæœƒæ•´å¡Šéš±è— -->
      <div id="targetArea" style="margin-top:12px;">
        <div class="muted">ç›®æ¨™ç‰‡æ®µï¼š</div>
        <div id="targetText" class="target"></div>
        <div class="muted" id="progress"></div>
      </div>
    </div>

    <div class="card">
      <b>é–‹å§‹èƒŒèª¦</b>
      <div class="muted">é»é–‹å§‹å¾Œå¿µè‹±æ–‡ï¼›é–‹å§‹è­˜åˆ¥å¾Œèª²æ–‡æœƒè‡ªå‹•éš±è—ï¼Œé¿å…å·çœ‹ã€‚ï¼ˆçµæŸå¾ŒæŒ‰â€œæª¢æŸ¥/åœæ­¢/æ¸…ç©ºâ€æœƒé¡¯ç¤ºå›ä¾†å°ç…§ï¼‰</div>

      <div class="row" style="margin-top:10px;">
        <button id="startRec" class="primary">ğŸ™ï¸ é–‹å§‹è­˜åˆ¥</button>
        <button id="stopRec">åœæ­¢</button>
        <button id="clear">æ¸…ç©º</button>
        <button id="check" class="primary">æª¢æŸ¥</button>
      </div>

      <div style="margin-top:10px;">
        <div class="muted">ä½ çš„èƒŒèª¦å…§å®¹ï¼š</div>
        <textarea id="userText" placeholder="è­˜åˆ¥çµæœæœƒå‡ºç¾åœ¨é€™é‡Œï¼›æˆ–ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•è¼¸å…¥å†æª¢æŸ¥ã€‚"></textarea>
      </div>

      <div style="margin-top:12px;">
        <div class="muted">å°æ¯”çµæœï¼š</div>
        <div id="diffOut"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ========= æ–‡ç« è³‡æ–™ ========= */
const articles = {
  "2026-01-22":{
    title:"2026/01/22",
    text:`At the beginning, a tadpole lived in a pond. 
One day, a goose came and chased it. 
The tadpole was scared and felt cold. 
It left the water and hid under a stick. 
Nearby, an insect moved slowly. 
After a while, the goose went away. 
The pond became peaceful again. 
At the end, the tadpole swam back home and rested quietly.
`
  },
  "2026-01-14":{
    title:"2026/01/14",
    text:`A group of travelers from Asia arrived in Africa and stopped near a quiet pond. 
Under a tall coconut tree, I met a new friend and helped him feed the birds. 
Later, we walked to a hot spring, where white smoke rose into the sky. 
A small animal came out of a tree hole, and we laughed together. 
As the sun went down, we chased after the last light of the day and felt peaceful and happy.
`
  }
};

/* ========= DOM ========= */
const pageView = document.getElementById("pageView");
const pageRec  = document.getElementById("pageRec");
const tabView  = document.getElementById("tabView");
const tabRec   = document.getElementById("tabRec");

const selector = document.getElementById("articleSelector");
const selectorRec = document.getElementById("articleSelectorRec");
const loadArticleBtn = document.getElementById("loadArticle");
const loadArticleRecBtn = document.getElementById("loadArticleRec");

const modeEl = document.getElementById("mode");
const targetAreaEl = document.getElementById("targetArea");
const targetTextEl = document.getElementById("targetText");
const progressEl = document.getElementById("progress");
const userTextEl = document.getElementById("userText");
const diffOutEl = document.getElementById("diffOut");
const recMetaEl = document.getElementById("recMeta");
const recTitleLineEl = document.getElementById("recTitleLine");

/* ========= åŠŸèƒ½åˆ‡æ› ========= */
tabView.onclick = () => {
  pageView.style.display = "";
  pageRec.style.display = "none";
  tabView.classList.add("primary");
  tabRec.classList.remove("primary");
};

tabRec.onclick = () => {
  pageView.style.display = "none";
  pageRec.style.display = "";
  tabRec.classList.add("primary");
  tabView.classList.remove("primary");
  syncAndLoad("view", true);
};

/* ========= åˆå§‹åŒ–é¸å–® ========= */
function buildSelectors(){
  selector.innerHTML = "";
  selectorRec.innerHTML = "";
  Object.keys(articles).sort().forEach(k=>{
    const o1 = document.createElement("option");
    o1.value=k; o1.textContent=articles[k].title;
    selector.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value=k; o2.textContent=articles[k].title;
    selectorRec.appendChild(o2);
  });
}
buildSelectors();

/* ========= åˆ†æ®µ ========= */
let lines = [];
let segments = [];
let idx = 0;

function splitLines(t){
  return t.replace(/\r\n/g,"\n").split("\n").map(s=>s.trim()).filter(Boolean);
}

function buildSegments(mode){
  if(mode==="full"){
    segments = [lines.join(" ")];
    idx = 0;
    return;
  }
  const size = (mode==="single") ? 1 : 3;
  segments = [];
  for(let i=0;i<lines.length;i+=size){
    segments.push(lines.slice(i,i+size).join(" "));
  }
  idx = 0;
}

function renderTarget(){
  targetTextEl.textContent = segments[idx] || "";
  progressEl.textContent = `é€²åº¦ ${idx+1}/${segments.length}`;
}

/* ========= é¡¯ç¤º/éš±è—ç›®æ¨™ç‰‡æ®µ ========= */
function showTargetArea(){
  targetAreaEl.style.display = "";
}
function hideTargetArea(){
  targetAreaEl.style.display = "none";
}

/* ========= æ¸…ç©ºèƒŒèª¦è¼¸å…¥ ========= */
let recognition = null;
let finalTranscript = "";
let lastFinalChunk = "";
let recognizing = false;

function resetRecInput(){
  userTextEl.value = "";
  diffOutEl.innerHTML = "";
  finalTranscript = "";
  lastFinalChunk = "";
}

try { window.speechSynthesis.cancel(); } catch(e) {}
setTtsButtons("idle");

  
/* ========= è¼‰å…¥æ–‡ç« ï¼ˆæ ¸å¿ƒï¼‰ ========= */
function loadCurrentArticle(){
  const key = selector.value;
  const a = articles[key];

  // å±•ç¤ºé 
  document.getElementById("articleTitle").textContent = a.title;
  lines = splitLines(a.text);
  document.getElementById("articleMeta").textContent = `å…± ${lines.length} å¥`;
  document.getElementById("articleBody").textContent = a.text;

  // èƒŒèª¦é æ¨™é¡Œ/å¥æ•¸
  recMetaEl.textContent = `å…± ${lines.length} å¥`;
  recTitleLineEl.textContent = `ç•¶å‰ï¼š${a.title}`;

  // é‡å»ºåˆ†æ®µä¸¦æ¸²æŸ“
  buildSegments(modeEl.value);
  renderTarget();

  // âœ… æ¯æ¬¡è¼‰å…¥æ–‡ç« ï¼šè®“èª²æ–‡å¯è¦‹ï¼ˆæ–¹ä¾¿æº–å‚™ï¼‰
  showTargetArea();
}

loadArticleBtn.onclick = () => {
  loadCurrentArticle();
  showTargetArea();
};

loadArticleRecBtn.onclick = () => {
  selector.value = selectorRec.value;
  loadCurrentArticle();
  resetRecInput();
  showTargetArea();
};

/* ========= é›™å‘åŒæ­¥ + è‡ªå‹•è¼‰å…¥ ========= */
function syncAndLoad(from, reset=false){
  if(from==="view") selectorRec.value = selector.value;
  else selector.value = selectorRec.value;

  loadCurrentArticle();

  if(reset){
    resetRecInput();
    showTargetArea();
  }
}

selector.addEventListener("change", () => syncAndLoad("view", true));
selectorRec.addEventListener("change", () => syncAndLoad("rec", true));

/* ========= åˆ‡æ›æ¨¡å¼ï¼šå›åˆ°ç¬¬1æ®µ+æ¸…ç©º+é¡¯ç¤ºèª²æ–‡ ========= */
modeEl.addEventListener("change", () => {
  buildSegments(modeEl.value);
  idx = 0;
  renderTarget();
  resetRecInput();
  showTargetArea();
});

/* ========= ä¸Šä¸€æ®µ/ä¸‹ä¸€æ®µï¼šåˆ‡æ®µæ™‚é¡¯ç¤ºèª²æ–‡ï¼ˆæº–å‚™ï¼‰ ========= */
document.getElementById("prev").onclick = () => {
  if(idx>0){
    idx--;
    renderTarget();
    resetRecInput();
    showTargetArea();
  }
};
document.getElementById("next").onclick = () => {
  if(idx<segments.length-1){
    idx++;
    renderTarget();
    resetRecInput();
    showTargetArea();
  }
};

/* ========= âœ… æœ—è®€ï¼ˆå«æš«åœ/ç¹¼çºŒ/åœæ­¢ï¼‰ ========= */
let currentUtterance = null;

const btnTtsFullNormal = document.getElementById("ttsFullNormal");
const btnTtsFullSlow = document.getElementById("ttsFullSlow");
const btnTtsPause = document.getElementById("ttsPause");
const btnTtsResume = document.getElementById("ttsResume");
const btnTtsStop = document.getElementById("ttsStop");

const btnTtsTargetNormal = document.getElementById("ttsTargetNormal");
const btnTtsTargetSlow = document.getElementById("ttsTargetSlow");

function setTtsButtons(state){
  if(state === "idle"){
    btnTtsPause.disabled = true;
    btnTtsResume.disabled = true;
    btnTtsStop.disabled = true;
  }else if(state === "playing"){
    btnTtsPause.disabled = false;
    btnTtsResume.disabled = true;
    btnTtsStop.disabled = false;
  }else if(state === "paused"){
    btnTtsPause.disabled = true;
    btnTtsResume.disabled = false;
    btnTtsStop.disabled = false;
  }
}
setTtsButtons("idle");

function speak(text){
  if(!("speechSynthesis" in window)){
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æŒæœ—è®€ã€‚");
    return;
  }
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  currentUtterance = u;

  u.onstart = () => setTtsButtons("playing");
  u.onend = () => setTtsButtons("idle");
  u.onerror = () => setTtsButtons("idle");

  window.speechSynthesis.speak(u);
  setTimeout(()=>setTtsButtons("playing"), 150);
}

btnTtsFull.onclick = () => {
  const full = articles[selector.value].text.replace(/\n/g," ");
  speak(full);
};

btnTtsPause.onclick = () => {
  try{
    window.speechSynthesis.pause();
    setTtsButtons("paused");
  }catch(e){}
};

btnTtsResume.onclick = () => {
  try{
    window.speechSynthesis.resume();
    setTtsButtons("playing");
  }catch(e){}
};

btnTtsStop.onclick = () => {
  try{ window.speechSynthesis.cancel(); }catch(e){}
  setTtsButtons("idle");
};

document.getElementById("ttsTarget").onclick = () => {
  const t = (segments[idx] || "").trim();
  if(!t) return;
  speak(t);
};

/* ========= âœ… èªéŸ³è­˜åˆ¥ï¼ˆé˜²é‡è¦†çˆ†å­—ï¼‰ ========= */
document.getElementById("startRec").onclick = () => {
  // âœ… æ ¸å¿ƒéœ€æ±‚ï¼šæŒ‰ä¸‹é–‹å§‹è­˜åˆ¥é‚£ä¸€åˆ»ï¼Œèª²æ–‡ç«‹åˆ»æ¶ˆå¤±
  hideTargetArea();

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³è­˜åˆ¥ã€‚å»ºè­° Android Chrome + httpsã€‚");
    // ä¸æ”¯æ´ä¹Ÿçµ¦ä»–çœ‹å›ä¾†
    showTargetArea();
    return;
  }

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.interimResults = true;
  recognition.continuous = true;

  recognition.onstart = ()=> recognizing = true;
  recognition.onend = ()=> recognizing = false;

  recognition.onerror = (e)=>{
    recognizing = false;
    alert("èªéŸ³è­˜åˆ¥å‡ºéŒ¯/è¢«é˜»æ­¢ï¼š" + (e.error || "unknown") + "\n\nè«‹æª¢æŸ¥ï¼šåœ°å€æ¬„ğŸ”’â†’ éº¥å…‹é¢¨ = å…è¨±");
    // å‡ºéŒ¯å°±é¡¯ç¤ºå›ä¾†
    showTargetArea();
  };

  recognition.onresult = (e) => {
    let finalText = "";
    let interim = "";

    for(let i=e.resultIndex;i<e.results.length;i++){
      const t = e.results[i][0].transcript;
      if(e.results[i].isFinal) finalText += t + " ";
      else interim += t;
    }

    const clean = finalText.replace(/\s+/g," ").trim();

    if(clean && clean !== lastFinalChunk){
      finalTranscript = (finalTranscript + " " + clean).replace(/\s+/g," ").trim();
      lastFinalChunk = clean;
    }

    userTextEl.value = (finalTranscript + (interim ? " " + interim : "")).trim();

    const MAX_CHARS = 1200;
    if(userTextEl.value.length > MAX_CHARS){
      userTextEl.value = userTextEl.value.slice(-MAX_CHARS);
      finalTranscript = userTextEl.value;
    }
  };

  try{
    recognition.start();
  }catch(err){
    alert("ç„¡æ³•å•Ÿå‹•èªéŸ³è­˜åˆ¥ï¼Œè«‹ç¢ºèªéº¥å…‹é¢¨æ¬Šé™å·²å…è¨±ã€‚");
    showTargetArea();
  }
};

document.getElementById("stopRec").onclick = () => {
  if(recognition && recognizing) recognition.stop();
  // åœæ­¢å¾Œé¡¯ç¤ºå›ä¾†ï¼ˆæ–¹ä¾¿å°ç…§ï¼‰
  showTargetArea();
};

document.getElementById("clear").onclick = () => {
  resetRecInput();
  // æ¸…ç©ºå¾Œé¡¯ç¤ºå›ä¾†ï¼ˆæ–¹ä¾¿æº–å‚™ï¼‰
  showTargetArea();
};

/* ========= å°æ¯” ========= */
function tokenize(s){
  return (s||"")
    .toLowerCase()
    .replace(/[â€œâ€"â€™]/g,"'")
    .replace(/[^a-z0-9'\s]/g," ")
    .replace(/\s+/g," ")
    .trim()
    .split(" ")
    .filter(Boolean);
}

document.getElementById("check").onclick = () => {
  const target = targetTextEl.textContent;
  const spoken = userTextEl.value;

  const a = tokenize(target);
  const b = tokenize(spoken);

  if(a.length===0) return alert("æ²’æœ‰ç›®æ¨™ç‰‡æ®µã€‚");
  if(b.length===0) return alert("è«‹å…ˆèƒŒèª¦æˆ–è¼¸å…¥å…§å®¹ã€‚");

  let html = "";
  for(let i=0;i<a.length;i++){
    const w = a[i];
    const s = b[i];

    if(s === w) html += `<span class="ok">${w}</span> `;
    else if(!s) html += `<span class="miss">[æ¼:${w}]</span> `;
    else html += `<span class="wrong">[${w}â†’${s}]</span> `;
  }
  diffOutEl.innerHTML = html;

  // æª¢æŸ¥å¾Œé¡¯ç¤ºèª²æ–‡å°ç…§
  showTargetArea();
};

/* ========= æ”¯æ´æç¤º ========= */
(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  document.getElementById("supportText").textContent =
    SR ? "èªéŸ³è­˜åˆ¥ï¼šå¯ç”¨ï¼ˆå»ºè­° Android Chromeï¼‰" : "èªéŸ³è­˜åˆ¥ï¼šä¸å¯ç”¨ï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰";
})();

/* ========= é¦–æ¬¡è¼‰å…¥ ========= */
window.addEventListener("DOMContentLoaded", () => {
  const keys = Object.keys(articles).sort();
  selector.value = keys[keys.length - 1]; // é»˜é¸æœ€æ–°çš„ä¸€å¤©
  selectorRec.value = selector.value;
  loadCurrentArticle();
  showTargetArea();
});
</script>
</body>
</html>




